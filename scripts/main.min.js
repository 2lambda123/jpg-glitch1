/**
 * almond 0.2.6 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

// MIT license

/** @license
 * JS Signals <http://millermedeiros.github.com/js-signals/>
 * Released under the MIT license
 * Author: Miller Medeiros
 * Version: 1.0.0 - Build: 268 (2012/11/29 05:48 PM)
 */

(function(){var e,t,n;(function(r){function d(e,t){return h.call(e,t)}function v(e,t){var n,r,i,s,o,u,a,f,c,h,p=t&&t.split("/"),d=l.map,v=d&&d["*"]||{};if(e&&e.charAt(0)===".")if(t){p=p.slice(0,p.length-1),e=p.concat(e.split("/"));for(f=0;f<e.length;f+=1){h=e[f];if(h===".")e.splice(f,1),f-=1;else if(h===".."){if(f===1&&(e[2]===".."||e[0]===".."))break;f>0&&(e.splice(f-1,2),f-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((p||v)&&d){n=e.split("/");for(f=n.length;f>0;f-=1){r=n.slice(0,f).join("/");if(p)for(c=p.length;c>0;c-=1){i=d[p.slice(0,c).join("/")];if(i){i=i[r];if(i){s=i,o=f;break}}}if(s)break;!u&&v&&v[r]&&(u=v[r],a=f)}!s&&u&&(s=u,o=a),s&&(n.splice(0,o,s),e=n.join("/"))}return e}function m(e,t){return function(){return s.apply(r,p.call(arguments,0).concat([e,t]))}}function g(e){return function(t){return v(t,e)}}function y(e){return function(t){a[e]=t}}function b(e){if(d(f,e)){var t=f[e];delete f[e],c[e]=!0,i.apply(r,t)}if(!d(a,e)&&!d(c,e))throw new Error("No "+e);return a[e]}function w(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function E(e){return function(){return l&&l.config&&l.config[e]||{}}}var i,s,o,u,a={},f={},l={},c={},h=Object.prototype.hasOwnProperty,p=[].slice;o=function(e,t){var n,r=w(e),i=r[0];return e=r[1],i&&(i=v(i,t),n=b(i)),i?n&&n.normalize?e=n.normalize(e,g(t)):e=v(e,t):(e=v(e,t),r=w(e),i=r[0],e=r[1],i&&(n=b(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return m(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:E(e)}}},i=function(e,t,n,i){var s,l,h,p,v,g=[],w;i=i||e;if(typeof n=="function"){t=!t.length&&n.length?["require","exports","module"]:t;for(v=0;v<t.length;v+=1){p=o(t[v],i),l=p.f;if(l==="require")g[v]=u.require(e);else if(l==="exports")g[v]=u.exports(e),w=!0;else if(l==="module")s=g[v]=u.module(e);else if(d(a,l)||d(f,l)||d(c,l))g[v]=b(l);else{if(!p.p)throw new Error(e+" missing "+l);p.p.load(p.n,m(i,!0),y(l),{}),g[v]=a[l]}}h=n.apply(a[e],g);if(e)if(s&&s.exports!==r&&s.exports!==a[e])a[e]=s.exports;else if(h!==r||!w)a[e]=h}else e&&(a[e]=n)},e=t=s=function(e,t,n,a,f){return typeof e=="string"?u[e]?u[e](t):b(o(e,t).f):(e.splice||(l=e,t.splice?(e=t,t=n,n=null):e=r),t=t||function(){},typeof n=="function"&&(n=a,a=f),a?i(r,e,t,n):setTimeout(function(){i(r,e,t,n)},4),s)},s.config=function(e){return l=e,l.deps&&s(l.deps,l.callback),s},e._defined=a,n=function(e,t,n){t.splice||(n=t,t=[]),!d(a,e)&&!d(f,e)&&(f[e]=[e,t,n])},n.amd={jQuery:!0}})(),n("lib/almond-0.2.6",function(){}),n("util/canvas",[],function(){function t(t,n){t.width!==n.width&&(t.width=n.width,e=!0),t.height!==n.height&&(t.height=n.height,e=!0),e&&(t.width=n.width,t.height=n.height),e=!1}function n(e,t){t.clearRect(t,0,0,e.width,e.height)}var e=!1;return{resize:t,clear:n}}),n("src/glitch",["util/canvas"],function(e){function w(i,s,o){c=s.seed/100,l=s.quality/100,h=s.amount/100,f=s.iterations,e.resize(t,i),e.resize(r,i),p=S(i,l),d=T(p),v=x(d);for(y=0;y<f;y++)E(d,v,c,h,y,f);m=new Image,m.onload=function(){n.drawImage(m,0,0),g=n.getImageData(0,0,i.width,i.height),o(g)},m.src=N(d)}function E(e,t,n,r,i,s){var o=e.length-t-4,u=parseInt(o/s*i,10),a=parseInt(o/s*(i+1),10),f=a-u,l=parseInt(u+f*n,10);l>o&&(l=o);var c=Math.floor(t+l);e[c]=Math.floor(r*256)}function S(e,t){var n=typeof t=="number"&&t<1&&t>0?t:.1;return i.putImageData(e,0,0),r.toDataURL("image/jpeg",n)}function x(e){var t=417;for(var n=0,r=e.length;n<r;n++)if(e[n]===255&&e[n+1]===218){t=n+2;break}return t}function T(e){var t=[],n,r,i;for(var s=23,o=e.length;s<o;s++){r=a[e.charAt(s)],n=(s-23)%4;switch(n){case 1:t.push(i<<2|r>>4);break;case 2:t.push((i&15)<<4|r>>2);break;case 3:t.push((i&3)<<6|r)}i=r}return t}function N(e){var t=["data:image/jpeg;base64,"],n,r,i,s;for(var s=0,o=e.length;s<o;s++){r=e[s],n=s%3;switch(n){case 0:t.push(u[r>>2]);break;case 1:t.push(u[(i&3)<<4|r>>4]);break;case 2:t.push(u[(i&15)<<2|r>>6]),t.push(u[r&63])}i=r}return n===0?(t.push(u[(i&3)<<4]),t.push("==")):n===1&&(t.push(u[(i&15)<<2]),t.push("=")),t.join("")}function C(e){var t=i.createImageData(e.width,e.height);return t.data.set(e.data),t}var t=document.createElement("canvas"),n=t.getContext("2d"),r=document.createElement("canvas"),i=r.getContext("2d"),s={width:10,height:10},o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",u=o.split(""),a={},f,l,c,h,p,d,v,m,g,y,b;return u.forEach(function(e,t){a[e]=t}),w}),function(){var e=0,t=["ms","moz","webkit","o"];for(var n=0;n<t.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,n){var r=(new Date).getTime(),i=Math.max(0,16-(r-e)),s=window.setTimeout(function(){t(r+i)},i);return e=r+i,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),n("lib/raf",function(){}),n("src/process",["src/glitch","util/canvas","lib/raf"],function(e,t){function h(e){f=e.signals,f["image-loaded"].add(d),f["control-updated"].add(p),f.saved.add(E)}function p(e){u=S(e),m()}function d(e){o||(a=e,y(a),g(a),b(a))}function v(){o||requestAnimationFrame(m),o=!0}function m(){a?b(a):o=!1}function g(e){r.drawImage(e,0,0),l=r.getImageData(0,0,n.width,n.height)}function y(e){t.clear(n,r),t.resize(n,e),t.clear(i,s),t.resize(i,e)}function b(t){o=!0,e(l,u,w)}function w(e){s.putImageData(e,0,0),o=!1,e=null}function E(){f["export-png"].dispatch(i.toDataURL("image/png"))}function S(e){var t={};for(var n in e)t[n]=parseInt(e[n],10);return n=null,t}var n=document.createElement("canvas"),r=n.getContext("2d"),i=document.getElementById("canvas"),s=i.getContext("2d"),o=!1,u,a,f,l,c;return{init:h}}),n("src/image",[],function(){function i(n){e=n.signals,t=new Image,e["set-new-src"].add(o),t.addEventListener("load",s,!1),o("lincoln.jpg")}function s(){u(t),e["image-loaded"].dispatch(t),n=!0}function o(e){t.src=e,n&&t.naturalWidth!==undefined&&t.naturalWidth!==0&&setTimeout(s,10)}function u(e){var t=0,n=e.naturalWidth,i=e.naturalWidth,s=n*i;s>r&&(t=r/s,n*=t,i*=t,e.naturalWidth=Math.floor(n),e.naturalWidth=Math.floor(i))}var e,t,n=!1,r=4e6;return{init:i}}),n("src/dragdrop",[],function(){function r(r){n=r.feature,e=r.signals,n["drag-drop"]&&n["file-api"]&&(document.addEventListener("drop",s,!1),document.addEventListener("dragover",i,!1),document.addEventListener("dragleave",i,!1),t=new FileReader,t.addEventListener("load",o,!1))}function i(e){e.preventDefault()}function s(e){e.preventDefault(),t.readAsDataURL(e.dataTransfer.files[0])}function o(t){e["set-new-src"].dispatch(t.target.result)}var e,t,n;return{init:r}}),n("src/controls",[],function(){function i(i){n=i.signals;if(i.feature["query-selector-all"]){var c=document.getElementById("controls");r=c.querySelectorAll(".control-input"),c.className+=" is-active";for(var h=0;h<r.length;h++){var p=r[h];p.addEventListener("input",s,!1),u(l(p.id),p.value),a(f(p.id),p.value)}t=!0,n["control-set"].add(o),n["control-updated"].dispatch(e)}}function s(e){e.target&&(e=e.target),u(l(e.id),e.value),a(f(e.id),e.value)}function o(t){var r,i={};for(var o in t)r=f(o),r.value=t[o],s(r),i[l(o)]=t[o];e=i,n["control-updated"].dispatch(e)}function u(r,i){e[r]=i,t&&n["control-updated"].dispatch(e)}function a(e,t){e.value!==t&&(e.value=t)}function f(e){var t,n=l(e),i;for(var s=0,o=r.length;s<o;s++){i=r[s].id;if(i!==e&&i.indexOf(n)!==-1){t=r[s];break}}return t}function l(e){return e.replace("-slider","").replace("-number","")}var e={},t=!1,n,r;return{init:i}}),n("src/export-png",[],function(){function n(n){e=n.signals,t=document.getElementById("png-button"),e["export-png"].add(r),e["control-updated"].add(i),t.addEventListener("click",i,!1)}function r(e){t.href=e,t.classList.add("is-active")}function i(){t.classList.remove("is-active")}var e,t;return{init:n}}),n("src/save-button",[],function(){function n(n){e=n.signals,t=document.getElementById("save-button"),t.addEventListener("click",r,!1)}function r(t){t.preventDefault(),e.saved.dispatch()}var e,t;return{init:n}}),n("util/trigger-event",[],function(){function e(e,t){var n;if(e.ownerDocument)n=e.ownerDocument;else{if(e.nodeType!==9)throw new Error("Invalid node passed to fireEvent: "+e.id);n=e}if(e.fireEvent){var r=n.createEventObject();r.synthetic=!0,e.fireEvent("on"+t,r)}else if(e.dispatchEvent){var i="";switch(t){case"click":case"mousedown":case"mouseup":i="MouseEvents";break;case"focus":case"change":case"blur":case"select":i="HTMLEvents";break;default:throw"triggerEvent: Couldnâ€™t find an event class for event "+t+"."}var r=n.createEvent(i),s=t=="change"?!1:!0;r.initEvent(t,s,!0),r.synthetic=!0,e.dispatchEvent(r)}}return e}),n("src/import-button",["util/trigger-event"],function(e){function f(e){n=e.signals,t=e.feature,t["file-api"]&&(s=new FileReader,r=document.getElementById("import-button"),i=document.getElementById("import-input"),s.addEventListener("load",h,!1),r.addEventListener("click",l,!1),i.addEventListener("change",c,!1))}function l(t){t.preventDefault(),u||e(i,"click")}function c(e){var t=e.target.files;t[0]&&t[0].type&&a.indexOf(t[0].type)!==-1&&s.readAsDataURL(t[0])}function h(e){n["set-new-src"].dispatch(e.target.result)}var t,n,r,i,s,o,u=!1,a=["image/png","image/jpg","image/jpeg"];return{init:f}}),n("src/random-button",[],function(){function i(i){e=i.signals,i.feature["query-selector-all"]&&(t=document.querySelectorAll(".control-slider"),r=u(t),n=document.getElementById("random-button"),n.addEventListener("click",s,!1),n.classList.remove("is-hidden"))}function s(e){e.preventDefault(),o()}function o(){var t={},n;for(var i in r)n=r[i],t[i]=a(n.min,n.max);e["control-set"].dispatch(t)}function u(e){var t={},n;for(var r=0,i=e.length;r<i;r++)n=e[r],t[n.id]={min:parseInt(n.min,10),max:parseInt(n.max,10)};return t}function a(e,t){return Math.floor(Math.random()*(t-e+1))+e}var e,t,n,r={};return{init:i}}),n("util/feature-test",[],function(){function t(t,n){var r=!0,i={},s=[];for(var o in e){var u=e[o].test();u||e[o].required&&(r=!1,s.push(o)),i[o]=u}r?t(i):n(s,i)}var e={canvas:{required:!0,test:function(){return!!document.createElement("canvas").getContext}},"query-selector-all":{required:!1,test:function(){return!!document.querySelectorAll}},"drag-drop":{required:!1,test:function(){return"draggable"in document.createElement("span")}},"file-api":{required:!1,test:function(){return typeof FileReader!="undefined"}}};return t}),function(e){function t(e,t,n,r,i){this._listener=t,this._isOnce=n,this.context=r,this._signal=e,this._priority=i||0}function r(e,t){if(typeof e!="function")throw new Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",t))}function i(){this._bindings=[],this._prevParams=null;var e=this;this.dispatch=function(){i.prototype.dispatch.apply(e,arguments)}}t.prototype={active:!0,params:null,execute:function(e){var t,n;return this.active&&!!this._listener&&(n=this.params?this.params.concat(e):e,t=this._listener.apply(this.context,n),this._isOnce&&this.detach()),t},detach:function(){return this.isBound()?this._signal.remove(this._listener,this.context):null},isBound:function(){return!!this._signal&&!!this._listener},isOnce:function(){return this._isOnce},getListener:function(){return this._listener},getSignal:function(){return this._signal},_destroy:function(){delete this._signal,delete this._listener,delete this.context},toString:function(){return"[SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}},i.prototype={VERSION:"1.0.0",memorize:!1,_shouldPropagate:!0,active:!0,_registerListener:function(e,n,r,i){var s=this._indexOfListener(e,r),o;if(s!==-1){o=this._bindings[s];if(o.isOnce()!==n)throw new Error("You cannot add"+(n?"":"Once")+"() then add"+(n?"Once":"")+"() the same listener without removing the relationship first.")}else o=new t(this,e,n,r,i),this._addBinding(o);return this.memorize&&this._prevParams&&o.execute(this._prevParams),o},_addBinding:function(e){var t=this._bindings.length;do--t;while(this._bindings[t]&&e._priority<=this._bindings[t]._priority);this._bindings.splice(t+1,0,e)},_indexOfListener:function(e,t){var n=this._bindings.length,r;while(n--){r=this._bindings[n];if(r._listener===e&&r.context===t)return n}return-1},has:function(e,t){return this._indexOfListener(e,t)!==-1},add:function(e,t,n){return r(e,"add"),this._registerListener(e,!1,t,n)},addOnce:function(e,t,n){return r(e,"addOnce"),this._registerListener(e,!0,t,n)},remove:function(e,t){r(e,"remove");var n=this._indexOfListener(e,t);return n!==-1&&(this._bindings[n]._destroy(),this._bindings.splice(n,1)),e},removeAll:function(){var e=this._bindings.length;while(e--)this._bindings[e]._destroy();this._bindings.length=0},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(e){if(!this.active)return;var t=Array.prototype.slice.call(arguments),n=this._bindings.length,r;this.memorize&&(this._prevParams=t);if(!n)return;r=this._bindings.slice(),this._shouldPropagate=!0;do n--;while(r[n]&&this._shouldPropagate&&r[n].execute(t)!==!1)},forget:function(){this._prevParams=null},dispose:function(){this.removeAll(),delete this._bindings,delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}};var s=i;s.Signal=i,typeof n=="function"&&n.amd?n("lib/signals-1.0.0",[],function(){return s}):typeof module!="undefined"&&module.exports?module.exports=s:e.signals=s}(this);var r=typeof _basepath_=="string"?_basepath_+"/":"";e.config({baseUrl:r+"scripts/",waitSeconds:5,urlArgs:"bust="+(new Date).getTime(),shim:{"lib/delaunay":{exports:"triangulate"}}}),t(["src/process","src/image","src/dragdrop","src/controls","src/export-png","src/save-button","src/import-button","src/random-button","util/feature-test","lib/signals-1.0.0"],function(e,t,n,r,i,s,o,u,a,f){function l(a){var l={feature:a,signals:{"image-loaded":new f,"set-new-src":new f,"control-set":new f,"control-updated":new f,"export-png":new f,saved:new f}};e.init(l),n.init(l),r.init(l),i.init(l),s.init(l),o.init(l),u.init(l),t.init(l)}function c(e){var t=document.createElement("div"),n="sorry. it looks like your browser is missing some of the features ";n+="("+e.join(", ")+") that are required to run this ",n+="experiment.",t.innerText=n,t.className="missing-feature",document.getElementsByTagName("body")[0].appendChild(t)}a(l,c)}),n("main",function(){})})();